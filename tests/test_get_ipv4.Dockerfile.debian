FROM debian:stable-slim

ENV VERBOSE_LOGGING=true

SHELL [“/bin/bash”, “-o”, “pipefail”, “-c”]

COPY / /workdir/

# Install busybox
RUN set -x && \
    apt-get update && \
    apt-get install --no-install-recommends -y busybox && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Test with busybox
RUN bash -x /workdir/helpers/get_ipv4.sh dns.google | head -1 | grep -P '^8\.8\.(8|4)\.(8|4)$'

# Remove busybox & install dig
RUN apt-get remove -y busybox && \
    apt-get install --no-install-recommends -y dnsutils && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Test with dig
RUN bash -x /workdir/helpers/get_ipv4.sh dns.google | head -1 | grep -P '^8\.8\.(8|4)\.(8|4)$'

# Remove dig & install s6-overlay
RUN apt-get remove -y dnsutils && \
    apt-get install --no-install-recommends -y \
      ca-certificates \
      curl \
      file \
      gnupg \
      && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* && \
    curl -s https://raw.githubusercontent.com/mikenye/deploy-s6-overlay/master/deploy-s6-overlay.sh | sh
    
# Test with s6-overlay
RUN bash -x /workdir/helpers/get_ipv4.sh dns.google | head -1 | grep -P '^8\.8\.(8|4)\.(8|4)$'
